本文介绍如何通过网易云信 NERoom SDK 收发自定义房间信令，用于实现实时字幕展示等功能。

## 发送自定义房间信令

您可以通过客户端或服务端发送自定义房间信令：

- **客户端**：调用 [`sendCustomMessage`](https://pub.dev/documentation/netease_roomkit/latest/netease_roomkit/NEMessageChannelService/sendCustomMessage.html) 方法
- **服务端**：调用 [POST /neroom/v3/rooms/:room_archive_id/custom_messages](https://doc.yunxin.163.com/neroom/server-apis/TY1NzA1MzE?platform=server) 接口

**客户端示例代码**：

```Dart
/// 给房间内的指定用户发送透传消息，如房间内信令
///
/// 参数说明：
/// [roomUuid] - 房间ID
/// [userUuid] - 用户ID，接收消息的目标用户
/// [commandId] - 消息类型，可用区间为 10000-19999
/// [data] - 自定义的消息内容
///
/// 注意：如需发送聊天消息请使用 [NERoomChatController]
NERoomKit.instance.messageChannelService.sendCustomMessage(
    roomUuid, userUuid, commandId, data);
```

## 接收自定义房间信令

**完整流程示例**：

```Dart
// 1. 创建并保存回调实例
final messageChannelCallback = NEMessageChannelCallback(
  onCustomMessageReceiveCallback: _onReceiveChannelMessage,
);

// 2. 添加消息监听
NERoomKit.instance.messageChannelService
    .addMessageChannelCallback(messageChannelCallback);

// 3. 处理接收到的消息
void _onReceiveChannelMessage(NECustomMessage message) {
  // 处理接收到的自定义信令
  print('收到自定义消息: ${message.data}');
  
  // 可以根据 message 中的属性进行处理
  // message.fromUserUuid  // 发送消息的用户ID
  // message.commandId     // 消息类型
  // message.data          // 消息内容
}

// 4. 当不再需要监听时，移除监听器
void dispose() {
  NERoomKit.instance.messageChannelService
      .removeMessageChannelCallback(messageChannelCallback);
}
```

**关键步骤解析**：

1. **添加消息监听**。创建 `NEMessageChannelCallback` 回调实例并通过 `addMessageChannelCallback` 方法注册监听。

2. **实现回调处理函数**。在 `onCustomMessageReceiveCallback` 回调中处理收到的自定义信令，可根据业务需求解析和展示消息。

3. **移除消息监听**。当不再需要接收消息时（如页面销毁时），请务必调用 `removeMessageChannelCallback` 方法移除监听器，避免内存泄漏。

## API 文档

| 方法 | 功能描述 |
| :-- | :-- |
| [`sendCustomMessage`](https://pub.dev/documentation/netease_roomkit/latest/netease_roomkit/NEMessageChannelService/sendCustomMessage.html) | 给房间内指定用户发送透传消息 |
| [`addMessageChannelCallback`](https://pub.dev/documentation/netease_roomkit/latest/netease_roomkit/NEMessageChannelService/addMessageChannelCallback.html) | 添加消息事件监听 |
| [`removeMessageChannelCallback`](https://pub.dev/documentation/netease_roomkit/latest/netease_roomkit/NEMessageChannelService/removeMessageChannelCallback.html) | 移除消息事件监听 |
| [`NEMessageChannelCallback`](https://pub.dev/documentation/netease_roomkit/latest/netease_roomkit/NEMessageChannelCallback-class.html) | 消息监听器类 |
| [`onCustomMessageReceiveCallback`](https://pub.dev/documentation/netease_roomkit/latest/netease_roomkit/NEMessageChannelCallback/onCustomMessageReceiveCallback.html) | 接收自定义房间信令的回调方法 |

## 最佳实践

- 根据不同的业务场景设计合理的 `commandId`，便于区分不同类型的消息。
- 使用结构化的 JSON 数据作为 `data` 参数，方便后续扩展。
- 在组件销毁时记得移除监听，避免内存泄漏。
- 考虑添加错误处理和重试机制，确保信令可靠传递。