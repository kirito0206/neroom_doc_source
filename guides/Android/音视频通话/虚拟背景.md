<!--keywords: 虚拟背景, 人像分割 -->

NERoom SDK 通过人像分割技术，自动识别用户人像，虚化用户周围的真实环境，或者以指定颜色的图片或自定义图像替代真实背景，从而实现设置虚拟背景。在音视频会议或教育场景中，虚拟背景不仅可以保护与会者的隐私，还可以作为主题宣传的背景墙。

## 功能原理

NERoom SDK 支持的虚拟背景采用自研的深度学习算法，在对当前视频帧做背景分割时利用前一帧的分割结果作为先验信息，同时在 video matting 中利用时序信息解决视频分割中可能出现的闪烁问题，提升分割效果，让您在使用虚拟背景的同时也能享受优质的视频通话体验。

## 注意事项

- 建议您在满足以下条件的场景中使用虚拟背景功能：

    - 采用高清摄像设备，避免遮挡摄像头且环境光线均匀。
    - 捕获的视频场景中无冗余物件，用户人像尽量保持上半身在画面内且基本无遮挡。
    - 背景色单一且尽量不与用户着装颜色相同。
    
- 开启虚拟背景对手机的性能有一定的要求，为了确保视频的清晰度和流畅度，开启虚拟背景的机型需要满足如下条件：

    - GPU Adreno 540 及以上
    - Mali-G78 及以上
- 若您设置背景图片为自定义本地图片，SDK 会在保证背景图片内容不变形的前提下，对图片进行一定程度上的缩放和裁剪，以适配视频采集分辨率。
- 暂不支持在 Texture 格式的视频或通过 Push 方法从自定义视频源获取的视频中设置虚拟背景。

## 前提条件

已在项目中添加**虚拟背景**功能的依赖。

若还未添加，请参考 [集成 SDK](https://doc.yunxin.163.com/neroom/guide/Dc4MTA4Mjk?platform=android#集成-sdk)。

## 配置步骤

1. 调用 `addPreviewRoomListener` 接口，添加预览房间事件监听。
2. 调用 `startPreview` 方法开启本地视频预览。
3. 调用 `enableVirtualBackground` 方法开启虚拟背景功能。

    调用该方法时，您需要设置 `enabled` 参数为 `true` 开启虚拟背景功能，并设置 `NERoomVirtualBackgroundSource` 参数自定义背景图片的类型。

    场景 | 配置步骤 | 
    ---- | -------------- |
    设置背景图片为纯色图片（默认）| 1. 设置 `backgroundSourceType` 参数为 `BACKGROUND_COLOR`。<br>2. 设置 `color` 参数自定义图片颜色，该参数的取值范围为 0x000000 ~ 0xFFFFFF，默认值为 0xFFFFFF，即白色。<note type="note"><ul> <li>纯色图片的格式为 RGB 定义的十六进制整数，不带 # 号。<br><li>若 color 值设置无效，SDK 会将背景图片设置为白色图片。</note> | 
    设置背景图片为自定义本地图片 |1. 设置 `backgroundSourceType` 参数为 `BACKGROUND_IMG`。<br>2. 设置 `source` 参数为自定义背景图片的本地绝对路径。<note type="note">自定义背景图片仅支持 JPG 和 PNG 格式。</note>|
    设置背景虚化 | 1. 设置 `backgroundSourceType` 参数为 `BACKGROUND_BLUR`。<br>2. 设置 `blur_degree` 参数指定虚化程度，具体枚举值如下：<ul> <li>虚化程度低：BLUR_DEGREE_LOW（1）。<br><li>虚化程度中：BLUR_DEGREE_MEDIUM（2）。<br><li>虚化程度高：BLUR_DEGREE_HIGH（3）。|


 
4. 启用该方法后，SDK 会触发虚拟背景启用成功与否的 `onRtcVirtualBackgroundSourceEnabled` 回调。
5. 若您需要取消虚拟背景，请调用 `enableVirtualBackground` 方法，设置 `enabled` 参数为 `false`，关闭虚拟背景功能。

## 示例代码

以设置虚拟背景为自定义本地图片为例。

```Java
final NEPreviewRoomContext[] previewRoomContext = {null};
NERoomService roomService = NERoomKit.getInstance()
        .getService(NERoomService.class);
roomService.previewRoom(new NEPreviewRoomParams(), new NEPreviewRoomOptions(), new NECallback<NEPreviewRoomContext>() {
    @Override
    public void onResult(int code, @Nullable String message, @Nullable NEPreviewRoomContext data) {
        previewRoomContext[0] = data;
    }
});
String externalPath = Environment.getExternalStorageDirectory().getPath();
previewRoomContext[0].getPreviewController().enableVirtualBackground(true,
        new NERoomVirtualBackgroundSource(NERoomVirtualBackgroundSource.BackgroundSourceType.BACKGROUND_IMG,0,
                externalPath, NERoomVirtualBackgroundSource.BlurDegree.BLUR_DEGREE_MEDIUM));
```

## API 参考

| 方法 | 功能描述 |
|:--|:--|
| [`addPreviewRoomListener`](https://doc.yunxin.163.com/neroom/references/android/dokka/Latest/zh/html/com/netease/yunxin/kit/roomkit/api/NEPreviewRoomContext.html#addPreviewRoomListener(com.netease.yunxin.kit.roomkit.api.NEPreviewRoomListener)) | 添加预览房间事件监听
| [`startPreview`](https://doc.yunxin.163.com/neroom/references/android/dokka/Latest/zh/html/com/netease/yunxin/kit/roomkit/api/NERoomRtcBaseController.html#startPreview(com.netease.yunxin.kit.roomkit.api.view.NERoomVideoView)) | 开始预览 | 
| [`enableVirtualBackground`](https://doc.yunxin.163.com/neroom/references/android/dokka/Latest/zh/html/com/netease/yunxin/kit/roomkit/api/NERoomRtcBaseController.html#enableVirtualBackground(java.lang.Boolean,com.netease.yunxin.kit.roomkit.api.model.NERoomVirtualBackgroundSource,java.lang.Boolean)) | 开启或关闭虚拟背景 |
| [`onRtcVirtualBackgroundSourceEnabled`](https://doc.yunxin.163.com/neroom/references/android/dokka/Latest/zh/html/com/netease/yunxin/kit/roomkit/api/NEPreviewRoomListenerAdapter.html#onRtcVirtualBackgroundSourceEnabled(java.lang.Boolean,java.lang.Integer)) | 是否成功启用虚拟背景的回调通知|

## 错误码

虚拟背景相关错误原因说明请参见 [`NERoomVirtualBackgroundSourceStateReason`](https://doc.yunxin.163.com/neroom/references/android/dokka/Latest/zh/html/com/netease/yunxin/kit/roomkit/api/model/NERoomVirtualBackgroundSourceStateReason.html)。