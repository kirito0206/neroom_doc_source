本文主要介绍如何通过 NERoom SDK 在房间内实现聊天室消息的发送。

## 功能介绍

### 消息类型

| 类型 | 描述 |
| ---- | ---- |
| 文本消息 | 文本消息的内容是文本，可以包含超链接、emoji 表情符号等。表情消息可基于文本消息实现。文本消息大小限制为 5 KB。|
| 多媒体消息 | 多媒体消息包括文件消息和图片消息。|
| 自定义消息 | 开发者自定义的消息类型，例如红包消息、石头剪子布等形式的消息。目前仅支持 RESTful API 发送自定义消息。|

### 功能原理

![消息收发.png](https://yx-web-nosdn.netease.im/common/440c608d23a1efa056c0450f3d0e8c54/消息收发.png)

**消息收发流程如下**：

1. 房间内的用户 A 发送一条消息到云信的 NERoom IM 服务器。
2. IM 服务器投递给房间内聊天室内的其他成员。如果消息为广播消息，则全员投递，如果为定向消息，则仅投递指定的成员。
3. 目标用户收到消息。

## 注意事项

- 用户只有加入聊天室后，才能发送消息。
- 最新版本可支持文本消息、自定义消息、图片消息以及文件消息，暂不支持语音消息、视频消息等其他类型的消息。

## 给单人发送消息

### 配置步骤

1. 调用 `getRoomContext` 接口，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。
    
2. 调用 `sendDirectTextMessage` 接口，定向给某个人发送文本消息。参数说明如下表所示。

    名称 | 类型 |  描述 |
    ---- | ---- | ----
    userUuid | string | 接收方的用户 ID。 |
    message | string | 文本消息的内容。 |
    chatroomType | [NEChatroomType](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Enums/NEChatroomType.html) | 聊天室类型。 | 
    senderExtension | [String: Any] | 扩展信息。 | 

### 示例代码

实现给单人发送消息的示例代码如下：

```swift
let roomContext = NERoomKit.shared().roomService.getRoomContext(roomUuid: "房间ID")

guard let roomContext = roomContext else {
    return
}
roomComtext.chatController.sendDirectTextMessage(userUuid: "xxx", message: "xxx") { code, string, _ in 
    if code == 0 {
        print("Successfully send direct message")
    } else {
        print("Failed to send direct message. Rease: \(string ?? "")")
    }
}
```

## 给多人发送消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。
    
2. 调用 `sendGroupTextMessage` 方法，给多人发送文本消息。

    名称 | 类型 |  描述 |
    ---- | ---- | ----
    userUuids | [String] | 消息接收方的用户 ID。示例：['userid01', 'userid02'] |
    message | string | 文本消息的内容。 |
    chatroomType | [NEChatroomType](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Enums/NEChatroomType.html) | 聊天室类型。 | 
    senderExtension | [String: Any] | 扩展信息。 | 

### 示例代码

实现给多人发送消息的示例代码如下：

```swift
let roomContext = NERoomKit.shared().roomService.getRoomContext(roomUuid: "房间ID")

guard let roomContext = roomContext else {
    return
}
roomContext.chatController.sendGroupTextMessage(userUuids: ["xxx", "xxx"], message: "xxx") { code, string, _ in 
    if code == 0 {
        print("Successfully send group message")
    } else {
        print("Failed to send group message. Rease: \(string ?? "")")
    }
}
```

## 发送广播消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendBroadcastTextMessage` 方法，向全员发送广播消息。

    名称 | 类型 |  描述 |
    ---- | ---- | ----
    message | string | 文本消息的内容。 |
    chatroomType | [NEChatroomType](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Enums/NEChatroomType.html) | 聊天室类型。 | 
    senderExtension | [String: Any] | 扩展信息。 | 

### 示例代码

实现发送广播消息的示例代码如下：

```swift
let roomContext = NERoomKit.shared().roomService.getRoomContext(roomUuid: "房间ID")

guard let roomContext = roomContext else {
    return
}
roomContext.chatController.sendBroadcastTextNessage(message: "xxx") { code, string, _ in 
    if code == 0 {
        print("Successfully send broadcast text message")
    } else {
        print("Failed to send broadcast text message. Rease: \(string ?? "")")
    }
}
```

## 发送图片消息

### 配置步骤

1. 调用 `getRoomContext` 接口，获取房间上下文。

    调用此方法时，您需要将 roomUid 设置为您所加入房间的 ID。

2. 监听消息附件上传进度。

3. 调用 `sendImageMessage` 接口，发送图片消息。相关参数说明如下表所示。

    名称 | 类型 |  描述 |
    ---- | ---- | ----
    _ messageUuid | String | 消息标识，可用于监听该消息附件上传的进度，可通过 [UUID.randomUUID()] 生成。 |
    imagePath | String | 图片路径。 |
    userUuids | [String] | 用户 ID 列表。<br>如果 `userUuids` 为空，表示发送全员消息。<br>如果 `userUuids` 不为空，表示给单人或多人发送消息。 |
    chatroomType | [NEChatroomType](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Enums/NEChatroomType.html) | 聊天室类型。 | 

4. 调用 `sendImageMessage` 接口会触发 `NERoomListener` 协议中的 `onChatroomMessageAttachmentProgress` 进度回调接口。

### 示例代码

实现发送图片消息的示例代码如下：

```swift
let roomContext = NERoomKit.shared().roomService.getRoomContext(roomUuid: "房间ID")

guard let roomContext = roomContext else {
    return
}
roomComtext.chatController.sendImageMessage("messageUuid", imagePath: "图片路径", userUuids:nil) { code, msg, _ in
    if code == 0 {
        print("Successfully send image message.")
    } else {
        print("Failed to send image message. Code: \(code). Msg: \(msg ?? "")")
    }
}

roomComtext.addRoomListener(listener: self)

// 进度回调
func onChatroomMessageAttachmentProgress(messageUuid: String, transferred: Int64, total: Int64) {
}
```

## 发送文件消息

### 配置步骤

1. 调用 `getRoomContext` 接口，获取房间上下文。

    调用此方法时，您需要将 roomUid 设置为您所加入房间的 ID。

2. 监听消息附件上传进度。

3. 调用 `sendFileMessage` 接口，发送图片消息。相关参数说明如下表所示。

    名称 | 类型 |  描述 |
    ---- | ---- | ----
    _ messageUuid | String | 消息标识，可用于监听该消息附件上传的进度，可通过 [UUID.randomUUID()] 生成。 |
    filePath | String | 文件路径。 |
    userUuids | [String] | 用户 ID 列表。<br>如果 `userUuids` 为空，表示发送全员消息。<br>如果 `userUuids` 不为空，表示给单人或多人发送消息。 |
    chatroomType | [NEChatroomType](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Enums/NEChatroomType.html) | 聊天室类型。 | 

4. 调用 `sendFileMessage` 接口，会触发 `NERoomListener`协议中的 `onChatroomMessageAttachmentProgress` 进度回调接口。

### 示例代码

实现发送文件消息的示例代码如下：

```swift
let roomContext = NERoomKit.shared().roomService.getRoomContext(roomUuid: "房间ID")

guard let roomContext = roomContext else {
    return
}
roomComtext.chatController.sendFileMessage("messageUuid", filePath: "文件路径", userUuids: nil) { code, msg, _ in
    if code == 0 {
        print("Successfully send file message.")
    } else {
        print("Failed to send file message. Code: \(code). Msg: \(msg ?? "")")
    }
}

roomComtext.addRoomListener(listener: self)

// 进度回调
func onChatroomMessageAttachmentProgress(messageUuid: String, transferred: Int64, total: Int64) {
}
```

## 发送广播自定义消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendBroadcastCustomMessage` 方法，向全员发送广播消息。

    名称 | 类型 |  描述 |
    ---- | ---- | ----
    message | string | 自定义消息的内容。 |
    chatroomType | [NEChatroomType](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Enums/NEChatroomType.html) | 聊天室类型。 | 

### 示例代码

实现发送广播自定义消息的示例代码如下：

```swift
let roomContext = NERoomKit.shared().roomService.getRoomContext(roomUuid: "房间ID")

guard let roomContext = roomContext else {
    return
}
roomContext.chatController.sendBroadcastCustomMessage(message: "xxx") { code, string, _ in 
    if code == 0 {
        print("Successfully send broadcast custom message")
    } else {
        print("Failed to send broadcast custom message. Rease: \(string ?? "")")
    }
}
```

## API 参考

| 方法 | 功能描述 |
| ---- | ---- |
| [sendBroadcastTextMessage](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Classes/NERoomChatController.html#/c:@M@NERoomKit@objc(cs)NERoomChatController(im)sendBroadcastTextMessageWithMessage:chatroomType:senderExtension:callback:) | 发送一条广播消息。|
| [sendDirectTextMessage](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Classes/NERoomChatController.html#/c:@M@NERoomKit@objc(cs)NERoomChatController(im)sendDirectTextMessageWithUserUuid:message:chatroomType:senderExtension:callback:) | 发送单聊消息。|
| [sendGroupTextMessage](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Classes/NERoomChatController.html#/c:@M@NERoomKit@objc(cs)NERoomChatController(im)sendGroupTextMessageWithUserUuids:message:chatroomType:senderExtension:callback:) | 给多人发送消息。|
| [sendImageMessage](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Classes/NERoomChatController.html#/c:@M@NERoomKit@objc(cs)NERoomChatController(im)sendImageMessage:imagePath:userUuids:chatroomType:callback:) | 发送图片消息。	|
| [sendFileMessage](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Classes/NERoomChatController.html#/c:@M@NERoomKit@objc(cs)NERoomChatController(im)sendFileMessage:filePath:userUuids:chatroomType:callback:) | 发送文件消息。 	|
| [sendBroadcastCustomMessage](https://doc.yunxin.163.com/neroom/references/iOS/jazzy/Latest/zh/html/Classes/NERoomChatController.html#/c:@M@NERoomKit@objc(cs)NERoomChatController(im)sendBroadcastCustomMessageWithMessage:chatroomType:callback:) | 发送广播自定义消息。 | 