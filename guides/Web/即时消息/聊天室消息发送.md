本文主要介绍如何通过 NERoom SDK 在房间内实现聊天室消息的发送。

## 功能介绍

### 消息类型

| 类型 | 描述 |
| ---- | ---- |
| 文本消息 | 文本消息的内容是文本，可以包含超链接、emoji 表情符号等。表情消息可基于文本消息实现。文本消息大小限制为 5 KB。 |
| 多媒体消息 | 多媒体消息包括文件消息和图片消息。 |
| 自定义消息 | 开发者自定义的消息类型，例如红包消息、石头剪子布等形式的消息。 | 

### 功能原理

![消息收发.png](https://yx-web-nosdn.netease.im/common/440c608d23a1efa056c0450f3d0e8c54/消息收发.png)

**消息收发流程如下**：

1. 房间内的用户 A 发送一条消息到云信的 NERoom 服务器。
2. NERoom 服务器投递给房间内聊天室内的其他成员。如果消息为广播消息，则全员投递，如果为定向消息，则仅投递指定的成员。
3. 目标用户收到消息。

## 注意事项

- 用户只有加入聊天室后，才能发送消息。
- 最新版本可支持文本消息、图片消息以及文件消息，暂不支持语音消息、视频消息等其他类型的消息。
- 给单人发送消息时，如果没有传入 userUuid，消息会发送失败。

## 给单人发送消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendDirectTextMessage` 方法，定向给某个人发送文本消息。相关参数说明如下表所示。

    名称 | 类型 | 描述 |
    ---- | ---- | ----
    userUuid | string | 接收方的用户 ID |
    message | string | 文本消息的内容 |
    chatroomType | NEChatroomType | 聊天室类型 |
    custom | string | 自定义信息 | 

### 示例代码

实现给单人发送消息的示例代码如下：

```
/**
 * 获取房间上下文NERoomContext
 * @param roomUuid 房间ID
 */
const NERoomContext = NERoomService.getRoomContext(roomUuid)

NERoomContext.chatController.sendDirectTextMessage(userUuid, message)
.then(res => {
    console.log(res, 'sendDirectTextMessage')
}).catch(err => {
    console.log(err, 'sendDirectTextMessage fail')
})
```

## 给多人发送消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。
    
2. 调用 `sendGroupTextMessage` 方法，定向给某个人发送文本消息。

    名称 | 类型 | 描述 |
    ---- | ---- | ----
    userUuids | string[] | 接收方的用户 ID |
    message | string | 文本消息的内容 |
    chatroomType | NEChatroomType | 聊天室类型 |
    custom | string | 自定义信息 | 

### 示例代码

实现给多人发送消息的示例代码如下：

```
/**
 * 获取房间上下文NERoomContext
 * @param roomUuid 房间ID
 */
const NERoomContext = NERoomService.getRoomContext(roomUuid)

NERoomContext.chatController.sendDirectTextMessage(userUuids, message)
.then(res => {
    console.log(res, 'sendDirectTextMessage')
}).catch(err => {
    console.log(err, 'sendDirectTextMessage fail')
})
```
## 发送广播文本消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendBroadcastTextMessage` 方法，向全员发送广播消息。

    名称 | 类型 | 描述 |
    ---- | ---- | ----
    message | string | 文本消息的内容 |
    chatroomType | NEChatroomType | 聊天室类型 |
    custom | string | 自定义信息 | 

### 示例代码

实现发送广播消息的示例代码如下：

```
/**
 * 获取房间上下文NERoomContext
 * @param roomUuid 房间ID
 */
const NERoomContext = NERoomService.getRoomContext(roomUuid)

NERoomContext.chatController.sendBroadcastTextMessage(message)
.then(res => {
    console.log(res, 'sendBroadcastTextMessage')
}).catch(err => {
    console.log(err, 'sendBroadcastTextMessage fail')
})
```

## 发送图片消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendImageMessage` 方法，向全员发送图片消息。相关参数说明如下表所示。

    名称 | 类型 | 描述 |
    ---- | ---- | ----
    messageUuid | string | 消息唯一 ID，可用于监听该消息附件上传的进度 |
    imageBlob | string/Blob | 图片对象 |
    width | number | 图片宽度 |
    height | number | 图片高度 | 
    userUuids | string[] | 接收方用户 ID 列表<br>如果 userUuids 为空，表示发送全员消息。<br>如果 userUuids 不为空，表示给单人或多人发送消息。 |
    chatroomType | NEChatroomType | 聊天室类型 |

3. 调用 `sendImageMessage` 接口会触发 `NERoomListener` 协议中的 `onChatroomMessageAttachmentProgress` 进度回调接口。

### 示例代码

实现发送图片消息的示例代码如下：

```
/**
 * 获取房间上下文NERoomContext
 * @param roomUuid 房间ID
 */
const NERoomContext = NERoomService.getRoomContext(roomUuid)

NERoomContext.chatController.sendImageMessage(params)
.then(res => {
    console.log(res, 'sendImageMessage')
}).catch(err => {
    console.log(err, 'sendImageMessage fail')
})

NERoomContext.addRoomListener({onChatroomMessageAttachmentProgress})

function onChatroomMessageAttachmentProgress(messageuuid:string, transferred: number, total: number){
}
```

## 发送文件消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendFileMessage` 方法，向全员发送广播消息。相关参数说明如下表所示。

    名称 | 类型 | 描述 |
    ---- | ---- | ----
    messageUuid | string | 消息唯一 ID，可用于监听该消息附件上传的进度 |
    fileBlob | string/Blob | 文件对象 |
    userUuids | string[] | 接收方用户 ID 列表<br>如果 userUuids 为空，表示发送全员消息。<br>如果 userUuids 不为空，表示给单人或多人发送消息。 |
    chatroomType | NEChatroomType | 聊天室类型 |

3. 调用 `sendFileMessage` 接口会触发 `NERoomListener` 协议中的 `onChatroomMessageAttachmentProgress` 进度回调接口。

4. 如果需要取消发送文件消息，则使用 `cancelSendFileMessage` 接口。

### 示例代码

实现发送文件消息的示例代码如下：

```
/**
 * 获取房间上下文NERoomContext
 * @param roomUuid 房间ID
 */
const NERoomContext = NERoomService.getRoomContext(roomUuid)

NERoomContext.chatController.sendFileMessage(params)
.then(res => {
    console.log(res, 'sendFileMessage')
}).catch(err => {
    console.log(err, 'sendFileMessage fail')
})

NERoomContext.addRoomListener({onChatroomMessageAttachmentProgress})

// 进度回调
function onChatroomMessageAttachmentProgress(messageUuid: String, transferred: Int64, total: Int64) {  
}

// 取消发送文件消息
NERoomContext.chatController.cancelSendFileMessage(messageUuid)
```

## 发送广播自定义消息

### 配置步骤

1. 调用 `getRoomContext` 方法，获取房间上下文。

    调用此方法时，您需要将 `roomUuid` 设置为您所加入房间的 ID。

2. 调用 `sendBroadcastCustomMessage` 方法，向全员发送广播消息。

    名称 | 类型 | 描述 |
    ---- | ---- | ----
    message | string | 文本消息的内容 |
    chatroomType | NEChatroomType | 聊天室类型 |

### 示例代码

实现发送广播自定义消息的示例代码如下：

```
/**
 * 获取房间上下文NERoomContext
 * @param roomUuid 房间ID
 */
const NERoomContext = NERoomService.getRoomContext(roomUuid)

NERoomContext.chatController.sendBroadcastCustomMessage(message)
.then(res => {
    console.log(res, 'sendBroadcastCustomMessage')
}).catch(err => {
    console.log(err, 'sendBroadcastCustomMessage fail')
})
```

## API 参考

| 方法 | 功能描述 |
| ---- | ---- |
| [sendBroadcastTextMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#sendBroadcastTextMessage) | 发送广播文本消息。|
| [sendDirectTextMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#sendDirectTextMessage) | 发送定向消息。|
| [sendGroupTextMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#sendGroupTextMessage) | 向多人发送消息。|
| [sendImageMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#sendImageMessage) | 发送图片消息。|
| [sendFileMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#sendFileMessage) | 发送文件消息。|
| [sendBroadcastCustomMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#sendBroadcastCustomMessage) | 发送广播自定义消息。 | 
| [cancelSendFileMessage](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomChatController.html#cancelSendFileMessage) | 取消发送文件消息。|
| [onReceiveChatroomMessages](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomListener.html#onReceiveChatroomMessages) | 聊天室消息接收回调。 | 
| [onChatroomMessageAttachmentProgress](https://doc.yunxin.163.com/neroom/references/web/typedoc/Latest/zh/html/interfaces/index.NERoomListener.html#onChatroomMessageAttachmentProgress) | 聊天室文件发送进度回调。|